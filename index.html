<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ADA Voice Capture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="app">
    <header class="app__header">
      <div class="app__header-main">
        <h1>ADA</h1>
        <p>AI D&D assistant for narrative, mechanics, and character art.</p>
      </div>
      <div class="app__header-user">
        <span id="currentUserLabel" class="user-label" hidden></span>
        <nav id="appNav" class="nav" hidden>
          <button type="button" class="nav__link" data-view="home">Home</button>
          <button type="button" class="nav__link" data-view="vault">My Characters</button>
          <button type="button" class="nav__link" data-view="campaigns">My Campaigns</button>
          <button type="button" class="nav__link" data-view="profile">Profile</button>
          <button type="button" class="nav__link nav__link--danger" id="logoutBtn">Logout</button>
        </nav>
      </div>
    </header>

    <section id="authSection" class="auth">
      <div id="loginView" class="auth__panel">
        <h2>Log in</h2>
        <form id="loginForm" autocomplete="on">
          <div class="field">
            <label for="loginUsername">Username</label>
            <input id="loginUsername" name="username" type="text" required />
          </div>
          <div class="field">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" name="password" type="password" required />
          </div>
          <button type="submit" class="btn btn--primary">Log in</button>
        </form>
        <p class="auth__switch">
          New here?
          <button type="button" id="showRegisterBtn" class="link-btn">Create an account</button>
        </p>
        <p id="authMessage" class="auth__message"></p>
      </div>

      <div id="registerView" class="auth__panel" hidden>
        <h2>Create account</h2>
        <form id="registerForm" autocomplete="off">
          <div class="field">
            <label for="registerUsername">Username</label>
            <input id="registerUsername" name="username" type="text" required />
          </div>
          <div class="field">
            <label for="registerPassword">Password</label>
            <input id="registerPassword" name="password" type="password" required />
          </div>
          <div class="field">
            <label for="registerPasswordConfirm">Confirm password</label>
            <input id="registerPasswordConfirm" name="passwordConfirm" type="password" required />
          </div>
          <button type="submit" class="btn btn--primary">Sign up</button>
        </form>
        <p class="auth__switch">
          Already have an account?
          <button type="button" id="showLoginBtn" class="link-btn">Back to login</button>
        </p>
      </div>
    </section>

    <section id="homeSection" hidden>
      <section class="controls">
        <button id="startBtn" class="btn btn--primary">Start Recording</button>
        <button id="stopBtn" class="btn" disabled>Stop</button>
        <span id="status" class="status">Idle</span>
      </section>

      <section class="output">
        <label for="transcript">Transcript</label>
        <textarea
          id="transcript"
          class="output__text"
          rows="12"
          placeholder="Your spoken notes will appear here..."
        ></textarea>
      </section>

      <section class="notes">
        <p class="hint">
          Tip: Talk as if you were journaling. For example, "We descended into the crypt and met a nervous goblin..."
        </p>
        <p class="warning" id="supportWarning" hidden>
          Speech recognition is not supported in this browser. Try the latest Chrome or Edge.
        </p>
      </section>

      <section class="rules-lookup">
        <div class="rules-lookup__header">
          <h2>Rules Lookup</h2>
          <p class="rules-lookup__subtitle">Search the D&D 5e SRD</p>
        </div>
        <div class="rules-lookup__search">
          <input
            type="text"
            id="rulesLookupInput"
            class="rules-lookup__input"
            placeholder="e.g., 'darkvision', 'fireball spell', 'ranger abilities'..."
          />
          <button id="rulesLookupBtn" class="btn btn--primary">Search</button>
        </div>
        <div id="rulesLookupResults" class="rules-lookup__results" hidden>
          <div class="rules-lookup__result-card">
            <h3 id="rulesResultTitle" class="rules-lookup__result-title"></h3>
            <div id="rulesResultText" class="rules-lookup__result-text"></div>
            <p id="rulesResultSource" class="rules-lookup__result-source"></p>
            <div class="rules-lookup__navigation">
              <button id="rulesLookupPrevBtn" class="btn btn--secondary btn--small" hidden>← Previous</button>
              <span id="rulesLookupCounter" class="rules-lookup__counter"></span>
              <button id="rulesLookupNextBtn" class="btn btn--secondary btn--small" hidden>Next →</button>
            </div>
          </div>
        </div>
        <div id="rulesLookupMessage" class="rules-lookup__message text-muted"></div>
      </section>

      <section class="forge">
        <div class="forge__header">
          <h2>Forge a Character</h2>
          <button id="forgeCharacterBtn" class="btn btn--primary">Forge from Transcript</button>
        </div>
        <div class="forge__name field">
          <label for="forgeCharacterName">Character name (optional)</label>
          <input
            type="text"
            id="forgeCharacterName"
            name="forgeCharacterName"
            placeholder="Elaria of the Moonlit Isles"
          />
        </div>
        <p class="forge__hint">
          We'll take your current transcript, infer race, class (including multiclass like Ranger/Warlock), and basic stats, then build a draft character sheet.
        </p>
        <div id="forgeStatus" class="forge__status"></div>
        <div id="forgedCharacter" class="forge__result" hidden></div>
        <button id="finishCharacterBtn" class="btn btn--primary forge__finish" disabled>
          Finish character creation
        </button>
        <p class="forge__finish-hint text-muted">
          This preview is not saved yet. Choose a portrait and click "Finish character creation" to add it to My Characters.
        </p>
      </section>

      <section class="portraits">
        <div class="portraits__header">
          <h2>Character Portraits</h2>
          <button id="generatePortraitsBtn" class="btn btn--secondary">
            Generate from Transcript
          </button>
        </div>
        <p class="portraits__hint">
          We'll suggest three D&amp;D-style character portraits from your notes. Pick one to save for this character.
        </p>
        <div class="portraits__grid">
          <article class="portrait-card" data-index="0">
            <div class="portrait-card__thumb-wrapper">
              <div class="portrait-card__placeholder">Portrait 1</div>
              <img
                id="portraitImg0"
                class="portrait-card__image"
                alt="Character portrait option 1"
                hidden
              />
            </div>
            <button class="btn portrait-card__select-btn" data-index="0" disabled>
              Select
            </button>
          </article>

          <article class="portrait-card" data-index="1">
            <div class="portrait-card__thumb-wrapper">
              <div class="portrait-card__placeholder">Portrait 2</div>
              <img
                id="portraitImg1"
                class="portrait-card__image"
                alt="Character portrait option 2"
                hidden
              />
            </div>
            <button class="btn portrait-card__select-btn" data-index="1" disabled>
              Select
            </button>
          </article>

          <article class="portrait-card" data-index="2">
            <div class="portrait-card__thumb-wrapper">
              <div class="portrait-card__placeholder">Portrait 3</div>
              <img
                id="portraitImg2"
                class="portrait-card__image"
                alt="Character portrait option 3"
                hidden
              />
            </div>
            <button class="btn portrait-card__select-btn" data-index="2" disabled>
              Select
            </button>
          </article>
        </div>

        <p id="portraitStatus" class="portraits__status"></p>
      </section>
    </section>

    <section id="profileSection" class="profile" hidden>
      <h2>Your profile</h2>
      <p>
        <strong>Username:</strong>
        <span id="profileUsername"></span>
      </p>
      <div id="profilePortrait" class="profile__portrait"></div>
      <p class="profile__hint">
        Portrait and settings are stored locally for now and tied to this browser.
      </p>
    </section>
    <section id="vaultSection" class="view" hidden>
      <div class="card">
        <div id="vaultListView">
          <h2>My Characters</h2>
          <p class="text-muted">Your personal roster of up to five D&D 5e characters.</p>
          <div id="vaultCharactersGrid" class="vault-grid" aria-live="polite"></div>
          <p id="vaultMessage" class="text-muted"></p>
        </div>

        <div id="vaultDetailView" class="vault-detail" hidden>
          <button type="button" id="vaultBackBtn" class="btn btn--secondary btn--small vault-detail__back">
            &larr; Back to My Characters
          </button>
          <div class="vault-detail__header">
            <div id="vaultDetailPortrait" class="vault-detail__portrait"></div>
            <div class="vault-detail__title">
              <h2 id="vaultDetailName">Character Sheet</h2>
              <p id="vaultDetailMeta" class="text-muted"></p>
              <label for="vaultDetailPrompt" class="text-muted">Backstory prompt</label>
              <textarea id="vaultDetailPrompt" class="vault-prompt" rows="4"></textarea>
            </div>
          </div>

          <div class="vault-detail__body">
            <div class="vault-detail__columns">
              <section class="vault-detail__col">
                <h3>Ability Scores</h3>
                <dl id="vaultDetailAbilities" class="vault-abilities"></dl>
              </section>
              <section class="vault-detail__col">
                <h3>Mechanics</h3>
                <div id="vaultDetailMechanics" class="vault-mechanics"></div>
                <div id="vaultDetailResources" class="vault-resources"></div>
                <div class="vault-resources__actions">
                  <button type="button" id="vaultLevelUpBtn" class="btn btn--primary btn--small" hidden>
                    Level up
                  </button>
                  <span id="vaultLevelUpStatus" class="status"></span>
                </div>
              </section>
            </div>

            <section class="vault-link">
              <h3>Link to Campaign</h3>
              <p class="text-muted">
                Choose a campaign to attach this character to. As a player you can only have one character per campaign;
                as a Dungeon Master you can link any number of NPCs.
              </p>
              <div class="vault-link__controls">
                <label for="vaultCampaignSelect" class="vault-link__label">Campaign</label>
                <select id="vaultCampaignSelect" class="vault-link__select"></select>
                <button type="button" id="vaultLinkBtn" class="btn btn--primary btn--small">Link character</button>
              </div>
              <p id="vaultLinkStatus" class="vault-link__status text-muted"></p>
            </section>

            <section class="vault-delete">
              <h3>Danger zone</h3>
              <p class="text-muted">Deleting a character removes it from your vault and any linked campaigns. This cannot be undone.</p>
              <button type="button" id="vaultDeleteBtn" class="btn btn--secondary btn--small">Delete character</button>
              <p id="vaultDeleteStatus" class="text-muted"></p>
            </section>
          </div>
        </div>
      </div>
    </section>
    <section id="campaignsSection" class="view" hidden>
      <div class="card">
        <div id="campaignsListView">
          <h2>My Campaigns</h2>
          <p class="text-muted">Create campaigns, see where you're the Dungeon Master, and where you're a player.</p>

          <div class="campaigns__controls">
            <div class="campaigns__filters">
              <button id="campaignFilterAll" class="btn btn--secondary btn--small" data-filter="all">All</button>
              <button id="campaignFilterDm" class="btn btn--secondary btn--small" data-filter="dm">As DM</button>
              <button id="campaignFilterPlayer" class="btn btn--secondary btn--small" data-filter="player">As Player</button>
            </div>
          </div>

          <div class="campaigns__new">
            <h3>Create a New Campaign</h3>
            <form id="createCampaignForm" class="campaigns__form">
              <div class="field">
                <label for="campaignName">Campaign name</label>
                <input type="text" id="campaignName" name="campaignName" placeholder="Curse of the Moonlit Isles" required />
              </div>
              <div class="field">
                <label for="campaignParticipants">Participants (comma-separated usernames, include yourself if desired)</label>
                <input type="text" id="campaignParticipants" name="campaignParticipants" placeholder="alice, bob, charlie" />
                <p class="field__hint">You'll be set as the Dungeon Master for campaigns you create.</p>
              </div>
              <button type="submit" class="btn btn--primary">Create campaign</button>
            </form>
          </div>

          <div class="campaigns__list" id="campaignsList" aria-live="polite"></div>
          <p id="campaignsMessage" class="text-muted"></p>

          <section class="adventures">
            <h3>Public Adventures</h3>
            <p class="text-muted">
              Try a solo run with ADA as your Dungeon Master. Pick an adventure and choose one of your characters that meets
              the level requirements.
            </p>
            <div id="adventuresList" class="adventures__grid" aria-live="polite"></div>
            <p id="adventuresMessage" class="text-muted"></p>
          </section>
        </div>

        <div id="campaignDetailView" class="campaign-detail" hidden>
          <button type="button" id="campaignBackBtn" class="btn btn--secondary btn--small campaign-detail__back">&larr; Back to My Campaigns</button>
          <h2 id="campaignDetailTitle">Campaign Dashboard</h2>
          <p id="campaignDetailMeta" class="text-muted"></p>
          <div class="campaign-detail__actions">
            <button type="button" id="campaignDeleteBtn" class="btn btn--danger btn--small" hidden>Delete campaign</button>
            <button type="button" id="campaignLeaveBtn" class="btn btn--secondary btn--small" hidden>Leave campaign</button>
            <button type="button" id="campaignCompleteBtn" class="btn btn--primary btn--small" hidden>Complete campaign</button>
            <span id="campaignActionStatus" class="status campaign-detail__status"></span>
          </div>

          <nav class="campaign-tabs" aria-label="Campaign sections">
            <button type="button" class="campaign-tab-button" data-tab="characters">Characters</button>
            <button type="button" class="campaign-tab-button" data-tab="journals">Journals</button>
            <button type="button" class="campaign-tab-button" data-tab="script">Script</button>
            <button type="button" class="campaign-tab-button" data-tab="dialogue">Dialogue</button>
          </nav>

          <div class="campaign-tab-panels">
            <section id="campaignTabCharacters" class="campaign-tab-panel" data-tab="characters">
              <p class="text-muted">Party characters linked to this campaign.</p>
              <div id="campaignCharactersGrid" class="party-grid"></div>
            </section>

            <section id="campaignTabJournals" class="campaign-tab-panel" data-tab="journals" hidden>
              <p class="text-muted">Polished narrative entries based on your session transcripts.</p>
              <div class="script-panel__actions" style="margin: 0 0 0.75rem 0;">
                <button type="button" id="campaignCreateJournalsBtn" class="btn btn--primary btn--small">
                  Create journals (each character)
                </button>
                <span id="campaignJournalsStatus" class="status">Idle</span>
              </div>
              <div id="campaignJournalsList" class="journal-list"></div>
            </section>

            <section id="campaignTabScript" class="campaign-tab-panel" data-tab="script" hidden>
              <div class="script-panel">
                <p class="text-muted">Store prepared descriptions, encounter notes, or AI-generated flavor text for this campaign.</p>
                <textarea
                  id="campaignScriptPrompt"
                  class="output__text script-panel__prompt"
                  rows="4"
                  placeholder="Describe the party's current location or status, and what kind of encounter you want to generate..."
                ></textarea>
                <div class="script-panel__actions">
                  <button type="button" id="campaignScriptGenerateBtn" class="btn btn--primary btn--small">
                    Generate encounter script
                  </button>
                  <span id="campaignScriptStatus" class="status script-panel__status">Idle</span>
                </div>
                <div id="campaignScriptsList" class="script-list"></div>
              </div>
            </section>

            <section id="campaignTabDialogue" class="campaign-tab-panel" data-tab="dialogue" hidden>
              <div class="dialogue-panel">
                <p class="text-muted">Use live voice capture during your session. Transcripts here are tagged to this campaign for future journals and mechanics.</p>
                <div class="controls dialogue-panel__controls">
                  <button id="campaignDialogueStartBtn" class="btn btn--primary">Start Session Capture</button>
                  <button id="campaignDialogueStopBtn" class="btn" disabled>Stop</button>
                  <span id="campaignDialogueStatus" class="status">Idle</span>
                </div>

                <div
                  id="dialogueContainer"
                  class="chat-thread"
                  role="log"
                  aria-label="Campaign dialogue"
                  aria-live="polite"
                  aria-relevant="additions"
                ></div>

                <form id="dialogueComposer" class="chat-composer" autocomplete="off">
                  <label for="dialogueTextInput" class="sr-only">Type a message</label>
                  <input
                    id="dialogueTextInput"
                    class="chat-composer__input"
                    type="text"
                    inputmode="text"
                    placeholder="Type a message…"
                  />
                  <button type="submit" id="dialogueSendBtn" class="btn btn--primary btn--small">
                    Send
                  </button>
                </form>

                <details class="dialogue-panel__raw">
                  <summary class="text-muted">Full transcript (read-only)</summary>
                  <textarea
                    id="campaignDialogueTranscript"
                    class="output__text dialogue-panel__transcript"
                    rows="8"
                    placeholder="Live session dialogue will appear here..."
                    readonly
                  ></textarea>
                </details>
                <p id="aiDmNotice" class="text-muted" hidden>
                  ADA is acting as the Dungeon Master for this campaign. Type what your character does next and send it to continue the story.
                </p>
                <div class="ai-dm-panel" id="aiDmPanel" hidden>
                  <div class="ai-dm__controls">
                    <button type="button" id="aiDmRollBtn" class="btn btn--secondary btn--small">Roll d20</button>
                    <span id="aiDmMechanics" class="ai-dm__mechanics text-muted"></span>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="speech.js"></script>
</body>
</html>
